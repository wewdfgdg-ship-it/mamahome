<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ë°”ì¼ ê²°ì œ ì²˜ë¦¬ - Mrble</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Apple Gothic', 'HY Gulim', MalgunGothic, sans-serif;
            background: rgb(245, 245, 247);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px 24px;
            max-width: 400px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        .icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            background: linear-gradient(135deg, rgb(41, 212, 193), rgb(30, 180, 165));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .icon.warning {
            background: linear-gradient(135deg, rgb(255, 214, 10), rgb(255, 204, 0));
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            color: rgb(29, 29, 31);
            margin-bottom: 16px;
        }

        .message {
            font-size: 16px;
            color: rgb(134, 134, 139);
            line-height: 1.5;
            margin-bottom: 32px;
        }

        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .payment-btn {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: white;
            border: 1px solid rgb(232, 232, 237);
            border-radius: 12px;
            text-decoration: none;
            color: rgb(29, 29, 31);
            transition: all 0.24s;
            cursor: pointer;
        }

        .payment-btn:hover {
            background: rgb(245, 245, 247);
            border-color: rgb(0, 113, 227);
        }

        .payment-btn.primary {
            background: rgb(0, 113, 227);
            color: white;
            border-color: rgb(0, 113, 227);
        }

        .payment-btn.primary:hover {
            background: rgb(0, 102, 204);
        }

        .payment-btn-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .payment-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .payment-label {
            text-align: left;
        }

        .payment-name {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 2px;
        }

        .payment-desc {
            font-size: 12px;
            color: rgb(134, 134, 139);
        }

        .arrow {
            color: rgb(134, 134, 139);
            font-size: 18px;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 24px 0;
            color: rgb(134, 134, 139);
            font-size: 14px;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgb(232, 232, 237);
        }

        .divider span {
            padding: 0 16px;
        }

        .help-text {
            font-size: 14px;
            color: rgb(134, 134, 139);
            line-height: 1.4;
            padding: 16px;
            background: rgb(245, 245, 247);
            border-radius: 8px;
            margin-top: 20px;
        }

        .back-btn {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 24px;
            background: rgb(245, 245, 247);
            color: rgb(29, 29, 31);
            border-radius: 8px;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.24s;
        }

        .back-btn:hover {
            background: rgb(232, 232, 237);
        }

        /* ë¡œë”© ìƒíƒœ */
        .loading {
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgb(232, 232, 237);
            border-top: 4px solid rgb(0, 113, 227);
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- PayApp ì„¤ì • íŒŒì¼ -->
    <script src="../config.js"></script>
</head>
<body>
    <div class="container">
        <div id="mainContent">
            <div class="icon warning">âš ï¸</div>
            <h1 id="errorTitle">ê²°ì œ ì—°ê²° ì˜¤ë¥˜</h1>
            <div class="message" id="errorMessage">
                ê²°ì œ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>
                ì•„ë˜ ë°©ë²• ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.
            </div>

            <div class="payment-options">
                <button onclick="retryWithApp()" class="payment-btn">
                    <div class="payment-btn-content">
                        <div class="payment-icon">ğŸ“±</div>
                        <div class="payment-label">
                            <div class="payment-name">ì•±ì—ì„œ ë‹¤ì‹œ ì‹œë„</div>
                            <div class="payment-desc">ì•±ì´ ì„¤ì¹˜ë˜ì–´ ìˆë‹¤ë©´ ë‹¤ì‹œ ì‹œë„</div>
                        </div>
                    </div>
                    <div class="arrow">â€º</div>
                </button>

                <button onclick="payWithWeb()" class="payment-btn primary">
                    <div class="payment-btn-content">
                        <div class="payment-icon">ğŸ’³</div>
                        <div class="payment-label">
                            <div class="payment-name">ì›¹ì—ì„œ ê²°ì œí•˜ê¸°</div>
                            <div class="payment-desc">ì¹´ë“œ ì •ë³´ ì§ì ‘ ì…ë ¥</div>
                        </div>
                    </div>
                    <div class="arrow">â€º</div>
                </button>

                <button onclick="payWithOther()" class="payment-btn">
                    <div class="payment-btn-content">
                        <div class="payment-icon">ğŸ¦</div>
                        <div class="payment-label">
                            <div class="payment-name">ë‹¤ë¥¸ ê²°ì œ ìˆ˜ë‹¨</div>
                            <div class="payment-desc">ê³„ì¢Œì´ì²´, ë¬´í†µì¥ ì…ê¸ˆ ë“±</div>
                        </div>
                    </div>
                    <div class="arrow">â€º</div>
                </button>
            </div>

            <div class="divider">
                <span>ë˜ëŠ”</span>
            </div>

            <div class="help-text">
                ğŸ’¡ <strong>ë„ì›€ë§</strong><br>
                ëª¨ë°”ì¼ ì›¹ë¸Œë¼ìš°ì €ì—ì„œ ì¼ë¶€ ì¹´ë“œ ì•±ì´ ì‹¤í–‰ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                'ì›¹ì—ì„œ ê²°ì œí•˜ê¸°'ë¥¼ ì„ íƒí•˜ì‹œë©´ ì¹´ë“œ ì •ë³´ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì—¬ ê²°ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </div>

            <a href="/pages/checkout.html" class="back-btn">ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>

        <div id="loadingContent" class="loading">
            <div class="loading-spinner"></div>
            <h2>ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</h2>
            <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
        </div>
    </div>

    <script>
        // URLì—ì„œ ê²°ì œ ì •ë³´ íŒŒì‹±
        const urlParams = new URLSearchParams(window.location.search);
        const paymentData = {
            goodname: urlParams.get('goodname') || 'ë¯¸ë¸” ì²´í—˜ë‹¨ ì„œë¹„ìŠ¤',
            price: urlParams.get('price') || '0',
            buyer: urlParams.get('buyer') || '',
            email: urlParams.get('email') || '',
            phone: urlParams.get('phone') || ''
        };

        // ì—ëŸ¬ íƒ€ì…ì— ë”°ë¼ ë©”ì‹œì§€ ë³€ê²½
        const errorType = urlParams.get('error');
        if (errorType === 'connection_timeout') {
            document.getElementById('errorTitle').textContent = 'PayApp ì„œë²„ ì—°ê²° ì‹¤íŒ¨';
            document.getElementById('errorMessage').innerHTML =
                'PayApp ê²°ì œ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>' +
                'ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ì‹œê±°ë‚˜ ë‹¤ë¥¸ ê²°ì œ ë°©ë²•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.';
        }

        // localStorageì— ê²°ì œ ì •ë³´ ì €ì¥ (ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ê²°ì œí•  ë•Œ ì‚¬ìš©)
        localStorage.setItem('pendingPayment', JSON.stringify(paymentData));

        // ì•± ë‹¤ì‹œ ì‹œë„
        function retryWithApp() {
            const appScheme = urlParams.get('scheme') || 'hdcardappcardansimclick://appcard';

            // ë¨¼ì € ì•± ìŠ¤í‚´ìœ¼ë¡œ ì‹œë„
            window.location.href = appScheme;

            // 3ì´ˆ í›„ ì•±ì´ ì‹¤í–‰ë˜ì§€ ì•Šìœ¼ë©´ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
            setTimeout(() => {
                alert('ì•±ì„ ì‹¤í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì•±ì´ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }, 3000);
        }

        // ì›¹ì—ì„œ ê²°ì œ (ê³µì‹ ë¬¸ì„œ ê¸°ë°˜)
        function payWithWeb() {
            showLoading();

            // PayAppì˜ ì›¹ ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™
            // config.jsì˜ ì„¤ì • ì‚¬ìš© (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
            const userid = (typeof CONFIG !== 'undefined' && CONFIG.userid) ? CONFIG.userid : 'ksbm';
            const linkkey = (typeof CONFIG !== 'undefined' && CONFIG.linkkey) ? CONFIG.linkkey : 'QLo9WUgFwaqAYjAiv6z86e1DPJnCCRVaOgT+oqg6zaM=';

            const payappUrl = `https://pay.payapp.kr/pay/pay.php?` +
                `userid=${userid}&` +
                `linkkey=${encodeURIComponent(linkkey)}&` +
                `shopname=${encodeURIComponent(paymentData.goodname)}&` +  // shopname í•„ìˆ˜
                `goodname=${encodeURIComponent('ë¯¸ë¸” ì²´í—˜ë‹¨ ì„œë¹„ìŠ¤')}&` +  // ìƒí’ˆëª…
                `price=${paymentData.price}&` +
                `recvphone=${encodeURIComponent(paymentData.phone)}&` +  // recvphone í•„ìˆ˜
                `buyer=${encodeURIComponent(paymentData.buyer)}&` +
                `buyeremail=${encodeURIComponent(paymentData.email)}&` +
                `returnurl=${encodeURIComponent(window.location.origin + '/pages/payment-complete.html')}&` +
                `smsuse=n&` +
                `device_type=MOBILE&` +
                `mobile_view=Y&` +
                `skip_security_app=Y&` +
                `skip_app_install=Y&` +
                `web_only=Y&` +
                `openpaytype=card`;  // ì¹´ë“œ ê²°ì œ

            window.location.href = payappUrl;
        }

        // ë‹¤ë¥¸ ê²°ì œ ìˆ˜ë‹¨ (ê³„ì¢Œì´ì²´)
        function payWithOther() {
            showLoading();

            // ê³„ì¢Œì´ì²´ ì˜µì…˜ìœ¼ë¡œ PayApp ì‹¤í–‰
            // config.jsì˜ ì„¤ì • ì‚¬ìš© (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
            const userid = (typeof CONFIG !== 'undefined' && CONFIG.userid) ? CONFIG.userid : 'ksbm';
            const linkkey = (typeof CONFIG !== 'undefined' && CONFIG.linkkey) ? CONFIG.linkkey : 'QLo9WUgFwaqAYjAiv6z86e1DPJnCCRVaOgT+oqg6zaM=';

            const payappUrl = `https://pay.payapp.kr/pay/pay.php?` +
                `userid=${userid}&` +
                `linkkey=${encodeURIComponent(linkkey)}&` +
                `shopname=${encodeURIComponent(paymentData.goodname)}&` +  // shopname í•„ìˆ˜
                `goodname=${encodeURIComponent('ë¯¸ë¸” ì²´í—˜ë‹¨ ì„œë¹„ìŠ¤')}&` +  // ìƒí’ˆëª…
                `price=${paymentData.price}&` +
                `recvphone=${encodeURIComponent(paymentData.phone)}&` +  // recvphone í•„ìˆ˜
                `buyer=${encodeURIComponent(paymentData.buyer)}&` +
                `buyeremail=${encodeURIComponent(paymentData.email)}&` +
                `returnurl=${encodeURIComponent(window.location.origin + '/pages/payment-complete.html')}&` +
                `smsuse=n&` +
                `device_type=MOBILE&` +
                `mobile_view=Y&` +
                `skip_security_app=Y&` +
                `skip_app_install=Y&` +
                `web_only=Y&` +
                `openpaytype=bank`;  // ê³„ì¢Œì´ì²´

            window.location.href = payappUrl;
        }

        // ë¡œë”© í‘œì‹œ
        function showLoading() {
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('loadingContent').style.display = 'block';
        }

        // ì•± ìŠ¤í‚´ ì²˜ë¦¬ ì‹¤íŒ¨ ì‹œ ìë™ìœ¼ë¡œ ì´ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë˜ë„ë¡ ì„¤ì •
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('scheme')) {
                // ìŠ¤í‚´ ì˜¤ë¥˜ ê°ì§€
                console.log('ì•± ìŠ¤í‚´ ì˜¤ë¥˜ ê°ì§€:', e.message);
            }
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ì „ í˜ì´ì§€ì—ì„œ ì˜¨ ê²½ìš° í™•ì¸
        if (document.referrer && document.referrer.includes('payapp')) {
            console.log('PayAppì—ì„œ ë¦¬ë‹¤ì´ë ‰íŠ¸ë¨');
        }
    </script>
</body>
</html>