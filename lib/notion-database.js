import { Client } from '@notionhq/client';

// ÌôòÍ≤ΩÎ≥ÄÏàò ÌôïÏù∏
console.log('NOTION_API_KEY exists:', !!process.env.NOTION_API_KEY);
console.log('NOTION_DATABASE_ID:', process.env.NOTION_DATABASE_ID);
console.log('NOTION_BLOG_ROOT_ID:', process.env.NOTION_BLOG_ROOT_ID);
console.log('Using Database ID:', process.env.NOTION_BLOG_ROOT_ID || process.env.NOTION_DATABASE_ID);

const notion = new Client({
  auth: process.env.NOTION_API_KEY,
});

// notion Í∞ùÏ≤¥ ÌôïÏù∏
console.log('Notion client initialized:', !!notion);
console.log('Notion databases available:', !!notion.databases);

// Î∏îÎ°úÍ∑∏ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ID ÏÇ¨Ïö© (NOTION_BLOG_ROOT_ID)
const databaseId = process.env.NOTION_BLOG_ROOT_ID || process.env.NOTION_DATABASE_ID;

// Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ÏóêÏÑú Î™®Îì† Î∏îÎ°úÍ∑∏ Ìè¨Ïä§Ìä∏ Í∞ÄÏ†∏Ïò§Í∏∞
export async function getBlogPostsFromDatabase() {
  try {
    // Search APIÎ•º ÏÇ¨Ïö©ÌïòÏó¨ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïùò Î™®Îì† ÌéòÏù¥ÏßÄ Í∞ÄÏ†∏Ïò§Í∏∞
    const searchResponse = await notion.search({
      filter: {
        property: 'object',
        value: 'page'
      },
      sort: {
        direction: 'descending',
        timestamp: 'last_edited_time'
      }
    });
    
    // ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§Ïóê ÏÜçÌïú ÌéòÏù¥ÏßÄÎßå ÌïÑÌÑ∞ÎßÅ
    const pages = searchResponse.results.filter(
      page => page.parent?.database_id === databaseId
    );
    
    // PublishedÍ∞Ä trueÏù∏ ÌéòÏù¥ÏßÄÎßå ÌïÑÌÑ∞ÎßÅÌïòÍ≥† Ìè¨Îß∑ÌåÖ
    const posts = pages
      .filter(page => page.properties?.Published?.checkbox === true)
      .map((page) => {
        const properties = page.properties;
        
        return {
          id: page.id,
          title: properties['Ï†úÎ™©']?.title?.[0]?.text?.content || 
                 properties['Title']?.title?.[0]?.text?.content || 'Untitled',
          slug: properties['Slug']?.rich_text?.[0]?.text?.content || page.id,
          excerpt: properties['Excerpt']?.rich_text?.[0]?.text?.content || '',
          category: properties['Ïπ¥ÌÖåÍ≥†Î¶¨']?.select?.name || 
                   properties['Category']?.select?.name || 'General',
          tags: properties['tag']?.multi_select?.map(tag => tag.name) || 
                properties['Tags']?.multi_select?.map(tag => tag.name) || [],
          published: properties['Published']?.checkbox || false,
          publishedDate: properties['PublishedDate ']?.date?.start || 
                        properties['Published Date']?.date?.start || null,
          thumbnail: properties['Thumbnail']?.files?.[0]?.file?.url || 
                    properties['Thumbnail']?.files?.[0]?.external?.url || null,
          author: properties['Author']?.rich_text?.[0]?.text?.content || 'Admin',
        };
      });
    
    return posts;
  } catch (error) {
    console.error('Error fetching blog posts from database:', error);
    throw error;
  }
}

// Ïä¨Îü¨Í∑∏(ÎòêÎäî ID)Î°ú ÌäπÏ†ï Ìè¨Ïä§Ìä∏ Í∞ÄÏ†∏Ïò§Í∏∞
export async function getPostBySlug(slug) {
  try {
    // slugÍ∞Ä Ïã§Ï†úÎ°úÎäî ÌéòÏù¥ÏßÄ IDÏù¥ÎØÄÎ°ú ÏßÅÏ†ë ÌéòÏù¥ÏßÄÎ•º Í∞ÄÏ†∏ÏòµÎãàÎã§
    let page;
    
    try {
      // Î®ºÏ†Ä IDÎ°ú ÏßÅÏ†ë ÌéòÏù¥ÏßÄ Í∞ÄÏ†∏Ïò§Í∏∞ ÏãúÎèÑ
      page = await notion.pages.retrieve({ page_id: slug });
    } catch (error) {
      // IDÎ°ú Î™ª Ï∞æÏúºÎ©¥ null Î∞òÌôò
      console.log(`Page not found with ID: ${slug}`);
      return null;
    }

    if (!page) {
      return null;
    }
    const properties = page.properties;
    
    // ÌéòÏù¥ÏßÄ ÏΩòÌÖêÏ∏† Í∞ÄÏ†∏Ïò§Í∏∞
    const blocks = await getPageContent(page.id);
    
    return {
      id: page.id,
      title: properties['Ï†úÎ™©']?.title?.[0]?.text?.content || 
             properties['Title']?.title?.[0]?.text?.content || 'Untitled',
      slug: page.id,  // IDÎ•º slugÎ°ú ÏÇ¨Ïö©
      excerpt: properties['Excerpt']?.rich_text?.[0]?.text?.content || '',
      category: properties['Ïπ¥ÌÖåÍ≥†Î¶¨']?.select?.name || 
               properties['Category']?.select?.name || 'General',
      tags: properties['tag']?.multi_select?.map(tag => tag.name) || 
            properties['Tags']?.multi_select?.map(tag => tag.name) || [],
      published: properties['Published']?.checkbox || false,
      publishedDate: properties['PublishedDate ']?.date?.start || 
                    properties['Published Date']?.date?.start || null,
      thumbnail: properties['Thumbnail']?.files?.[0]?.file?.url || 
                 properties['Thumbnail']?.files?.[0]?.external?.url || null,
      author: properties['Author']?.rich_text?.[0]?.text?.content || 'Admin',
      content: blocks,
      htmlContent: await renderBlocksToHtml(blocks)
    };
  } catch (error) {
    console.error('Error fetching post by slug:', error);
    throw error;
  }
}

// ÌéòÏù¥ÏßÄ ÏΩòÌÖêÏ∏†(Î∏îÎ°ù) Í∞ÄÏ†∏Ïò§Í∏∞
export async function getPageContent(pageId) {
  const blocks = [];
  let cursor = undefined;

  try {
    while (true) {
      const response = await notion.blocks.children.list({
        block_id: pageId,
        start_cursor: cursor,
        page_size: 100,
      });

      blocks.push(...response.results);

      if (!response.has_more) {
        break;
      }
      cursor = response.next_cursor;
    }

    // Ï§ëÏ≤©Îêú Î∏îÎ°ù Ï≤òÎ¶¨
    for (const block of blocks) {
      if (block.has_children) {
        block.children = await getPageContent(block.id);
      }
    }

    return blocks;
  } catch (error) {
    console.error('Error fetching page content:', error);
    return blocks;
  }
}

// ÎÖ∏ÏÖò Î∏îÎ°ùÏùÑ HTMLÎ°ú Î≥ÄÌôò
export async function renderBlocksToHtml(blocks) {
  const html = [];
  let listItems = [];
  let listType = null;

  for (const block of blocks) {
    // Î¶¨Ïä§Ìä∏ Ï≤òÎ¶¨
    if (block.type === 'bulleted_list_item' || block.type === 'numbered_list_item') {
      const currentType = block.type === 'bulleted_list_item' ? 'ul' : 'ol';
      
      if (listType && listType !== currentType) {
        html.push(wrapList(listItems, listType));
        listItems = [];
      }
      
      listType = currentType;
      listItems.push(await renderBlock(block));
    } else {
      if (listItems.length > 0) {
        html.push(wrapList(listItems, listType));
        listItems = [];
        listType = null;
      }
      
      const rendered = await renderBlock(block);
      if (rendered) {
        html.push(rendered);
      }
    }
  }

  if (listItems.length > 0) {
    html.push(wrapList(listItems, listType));
  }

  return html.join('\n');
}

// Í∞úÎ≥Ñ Î∏îÎ°ù Î†åÎçîÎßÅ
async function renderBlock(block) {
  switch (block.type) {
    case 'paragraph':
      const text = getRichText(block.paragraph.rich_text);
      return text ? `<p>${text}</p>` : '';

    case 'heading_1':
      return `<h1>${getRichText(block.heading_1.rich_text)}</h1>`;

    case 'heading_2':
      return `<h2>${getRichText(block.heading_2.rich_text)}</h2>`;

    case 'heading_3':
      return `<h3>${getRichText(block.heading_3.rich_text)}</h3>`;

    case 'bulleted_list_item':
      const bulletText = getRichText(block.bulleted_list_item.rich_text);
      let bulletHtml = `<li>${bulletText}`;
      if (block.children) {
        bulletHtml += await renderBlocksToHtml(block.children);
      }
      bulletHtml += '</li>';
      return bulletHtml;

    case 'numbered_list_item':
      const numberText = getRichText(block.numbered_list_item.rich_text);
      let numberHtml = `<li>${numberText}`;
      if (block.children) {
        numberHtml += await renderBlocksToHtml(block.children);
      }
      numberHtml += '</li>';
      return numberHtml;

    case 'image':
      const imageUrl = block.image.type === 'file' 
        ? block.image.file.url 
        : block.image.external?.url;
      const caption = block.image.caption ? getRichText(block.image.caption) : '';
      return `
        <figure>
          <img src="${imageUrl}" alt="${caption}" style="max-width: 100%; height: auto;" />
          ${caption ? `<figcaption>${caption}</figcaption>` : ''}
        </figure>
      `;

    case 'code':
      const code = getRichText(block.code.rich_text);
      const language = block.code.language;
      return `<pre><code class="language-${language}">${escapeHtml(code)}</code></pre>`;

    case 'quote':
      return `<blockquote>${getRichText(block.quote.rich_text)}</blockquote>`;

    case 'divider':
      return '<hr />';

    case 'toggle':
      const toggleText = getRichText(block.toggle.rich_text);
      let toggleContent = '';
      if (block.children) {
        toggleContent = await renderBlocksToHtml(block.children);
      }
      return `
        <details>
          <summary>${toggleText}</summary>
          <div>${toggleContent}</div>
        </details>
      `;

    case 'callout':
      const emoji = block.callout.icon?.emoji || 'üí°';
      const calloutText = getRichText(block.callout.rich_text);
      return `
        <div style="padding: 16px; background: #f5f5f5; border-radius: 8px; margin: 16px 0;">
          <span style="font-size: 1.5em; margin-right: 8px;">${emoji}</span>
          <span>${calloutText}</span>
        </div>
      `;

    case 'to_do':
      const todoText = getRichText(block.to_do.rich_text);
      const checked = block.to_do.checked;
      return `
        <div style="display: flex; align-items: flex-start; margin: 8px 0;">
          <input type="checkbox" ${checked ? 'checked' : ''} disabled style="margin-right: 8px; margin-top: 3px;" />
          <span ${checked ? 'style="text-decoration: line-through; color: #999;"' : ''}>${todoText}</span>
        </div>
      `;

    case 'pdf':
      const pdfUrl = block.pdf.type === 'file' 
        ? block.pdf.file.url 
        : block.pdf.external?.url;
      return `
        <div style="margin: 16px 0; padding: 16px; border: 1px solid #e0e0e0; border-radius: 8px;">
          <a href="${pdfUrl}" target="_blank" style="display: flex; align-items: center; text-decoration: none; color: #333;">
            <span style="font-size: 1.5em; margin-right: 8px;">üìÑ</span>
            <span>PDF Î¨∏ÏÑú Î≥¥Í∏∞</span>
          </a>
        </div>
      `;

    case 'video':
      const videoUrl = block.video.type === 'file'
        ? block.video.file.url
        : block.video.external?.url;
      return `
        <div style="margin: 16px 0;">
          <video controls style="max-width: 100%; height: auto;">
            <source src="${videoUrl}" />
          </video>
        </div>
      `;

    case 'file':
      const fileUrl = block.file.type === 'file'
        ? block.file.file.url
        : block.file.external?.url;
      const fileName = block.file.name || 'ÌååÏùº';
      return `
        <div style="margin: 16px 0; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px;">
          <a href="${fileUrl}" target="_blank" style="display: flex; align-items: center; text-decoration: none; color: #333;">
            <span style="font-size: 1.2em; margin-right: 8px;">üìé</span>
            <span>${fileName}</span>
          </a>
        </div>
      `;

    case 'bookmark':
      const bookmarkUrl = block.bookmark.url;
      return `
        <div style="margin: 16px 0; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px;">
          <a href="${bookmarkUrl}" target="_blank" style="text-decoration: none; color: #0066cc;">
            üîó ${bookmarkUrl}
          </a>
        </div>
      `;

    case 'table':
      // ÌÖåÏù¥Î∏îÏùÄ Î≥µÏû°ÌïòÎØÄÎ°ú Í∞ÑÎã®Ìûà Ï≤òÎ¶¨
      return `<div style="margin: 16px 0; padding: 12px; background: #f5f5f5; border-radius: 8px;">üìä ÌÖåÏù¥Î∏î (ÏÉÅÏÑ∏ ÎÇ¥Ïö©ÏùÄ NotionÏóêÏÑú ÌôïÏù∏)</div>`;

    case 'column_list':
    case 'column':
      // Ïª¨Îüº Î†àÏù¥ÏïÑÏõÉÏùÄ ÏßÄÏõêÌïòÏßÄ ÏïäÏùå
      return '';

    default:
      console.log('Unsupported block type:', block.type);
      return '';
  }
}

// Rich text Ï≤òÎ¶¨
function getRichText(richTextArray) {
  if (!richTextArray || richTextArray.length === 0) return '';
  
  return richTextArray.map(richText => {
    let text = richText.text.content;
    const annotations = richText.annotations;
    
    if (annotations.bold) text = `<strong>${text}</strong>`;
    if (annotations.italic) text = `<em>${text}</em>`;
    if (annotations.underline) text = `<u>${text}</u>`;
    if (annotations.strikethrough) text = `<s>${text}</s>`;
    if (annotations.code) text = `<code>${text}</code>`;
    
    if (richText.text.link) {
      text = `<a href="${richText.text.link.url}" target="_blank" rel="noopener">${text}</a>`;
    }
    
    return text;
  }).join('');
}

// Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
function wrapList(items, type) {
  return `<${type}>${items.join('')}</${type}>`;
}

function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;',
  };
  return text.replace(/[&<>"']/g, m => map[m]);
}

